# VPSéƒ¨ç½²é—®é¢˜å¤„ç†æŒ‡å—

> **åŸºäºSite4 (ColorMagic) å’Œ Site6 (Txtmoji) å®æˆ˜ç»éªŒçš„å®Œæ•´å·¥ä½œæµç¨‹**  
> **æœ€åæ›´æ–°ï¼š2025-10-28**  
> **ç‰ˆæœ¬ï¼šv3.0ï¼ˆæ–°å¢çº¯Dockeréƒ¨ç½²æ–¹æ¡ˆï¼‰**

---

## âš ï¸ é‡è¦å£°æ˜ï¼šæ—§ç‰ˆæŒ‡å—çš„é—®é¢˜

### âŒ æ—§ç‰ˆæŒ‡å—çš„é”™è¯¯æ–¹æ³•ï¼ˆä¸è¦ä½¿ç”¨ï¼‰

1. **âŒ é”™è¯¯ï¼šè®©ç”¨æˆ·æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶åˆ°VPS**
   - é—®é¢˜ï¼šä¼šå¯¼è‡´GitçŠ¶æ€ä¸ä¸€è‡´
   - é—®é¢˜ï¼šå®¹æ˜“é—æ¼å…³è”æ–‡ä»¶
   - é—®é¢˜ï¼šTypeScriptç¼–è¯‘äº§ç‰©ä¼šä¸¢å¤±

2. **âŒ é”™è¯¯ï¼šç›´æ¥åœ¨VPSä¿®æ”¹ä»£ç æ–‡ä»¶**
   - é—®é¢˜ï¼šæ— æ³•éªŒè¯è¯­æ³•é”™è¯¯
   - é—®é¢˜ï¼šæ— æ³•æäº¤åˆ°Gitï¼Œå¯¼è‡´ç‰ˆæœ¬æ··ä¹±
   - é—®é¢˜ï¼šTypeScripté¡¹ç›®æ— æ³•ç¼–è¯‘

3. **âŒ é”™è¯¯ï¼šä¸æ–­é‡å¤æ— æ•ˆçš„éƒ¨ç½²å‘½ä»¤**
   - é—®é¢˜ï¼šæ²¡æœ‰è§£å†³æ ¹æœ¬åŸå› 
   - é—®é¢˜ï¼šæµªè´¹æ—¶é—´åœ¨æ— æ•ˆå°è¯•ä¸Š

---

## âœ… æ­£ç¡®çš„å·¥ä½œæµç¨‹ï¼ˆå¿…é¡»éµå¾ªï¼‰

### æ ¸å¿ƒåŸåˆ™

```
æœ¬åœ°å¼€å‘ â†’ æœ¬åœ°ç¼–è¯‘ â†’ Gitæäº¤ â†’ VPSæ‹‰å– â†’ VPSéƒ¨ç½²
    â†“          â†“         â†“         â†“         â†“
  ä¿®æ”¹ä»£ç    ç¼–è¯‘TS   æ¨é€GitHub   æ‹‰å–ä»£ç    é‡æ–°æ„å»º
```

**å…³é”®ç‚¹**ï¼š
1. âœ… æ‰€æœ‰ä»£ç ä¿®æ”¹å¿…é¡»åœ¨**æœ¬åœ°**å®Œæˆ
2. âœ… TypeScripté¡¹ç›®å¿…é¡»åœ¨**æœ¬åœ°**ç¼–è¯‘
3. âœ… ä¿®æ”¹å¿…é¡»é€šè¿‡**GitåŒæ­¥**åˆ°VPS
4. âœ… VPSåªåšé…ç½®ä¿®æ”¹ï¼ˆ.envæ–‡ä»¶ï¼‰å’Œéƒ¨ç½²æ“ä½œ

---

## ğŸ“Š é—®é¢˜åˆ†ç±»å’Œå¤„ç†æµç¨‹

### åˆ†ç±»1ï¼šä»£ç é—®é¢˜ï¼ˆéœ€è¦æœ¬åœ°ä¿®æ”¹ï¼‰

**ç‰¹å¾**ï¼š
- éœ€è¦ä¿®æ”¹ `.ts`ã€`.tsx`ã€`.js`ã€`.jsx` ç­‰æºä»£ç æ–‡ä»¶
- éœ€è¦ä¿®æ”¹ä¸šåŠ¡é€»è¾‘ã€è·¯ç”±é…ç½®ã€APIç«¯ç‚¹
- éœ€è¦æ·»åŠ æ–°åŠŸèƒ½æˆ–ä¿®å¤bug

**âœ… æ­£ç¡®æµç¨‹**ï¼š

```bash
# ========================================
# æ­¥éª¤1ï¼šæœ¬åœ°ä¿®æ”¹ä»£ç 
# ========================================
cd ~/Documents/GitHub/Image-Color-Analysis

# ä¿®æ”¹æ–‡ä»¶ï¼ˆä½¿ç”¨IDEæˆ–ç¼–è¾‘å™¨ï¼‰
# ä¾‹å¦‚ï¼šä¿®æ”¹ backend/src/index.ts

# ========================================
# æ­¥éª¤2ï¼šæœ¬åœ°ç¼–è¯‘ï¼ˆå¦‚æœæ˜¯TypeScripté¡¹ç›®ï¼‰
# ========================================
cd backend
npm run build

# éªŒè¯ç¼–è¯‘æˆåŠŸ
ls -la dist/
grep "ä½ çš„ä¿®æ”¹å†…å®¹å…³é”®è¯" dist/index.js

# ========================================
# æ­¥éª¤3ï¼šGitæäº¤
# ========================================
cd ..
git add backend/src/index.ts backend/dist/index.js
git commit -m "fix: æè¿°ä½ çš„ä¿®æ”¹"
git push origin main

# ========================================
# æ­¥éª¤4ï¼šVPSæ‹‰å–ä»£ç 
# ========================================
# åœ¨VPSç»ˆç«¯æ‰§è¡Œï¼š
ssh root@YOUR_VPS_IP
cd /docker/site4

# ä¿å­˜æœ¬åœ°.envä¿®æ”¹ï¼ˆå¦‚æœæœ‰ï¼‰
cp backend/.env backend/.env.backup

# æ‹‰å–æœ€æ–°ä»£ç 
git stash  # æš‚å­˜æœ¬åœ°ä¿®æ”¹
git pull origin main
git stash pop  # æ¢å¤æœ¬åœ°ä¿®æ”¹

# æ¢å¤.envæ–‡ä»¶ï¼ˆå¦‚æœè¢«è¦†ç›–ï¼‰
cp backend/.env.backup backend/.env

# ========================================
# æ­¥éª¤5ï¼šé‡æ–°ç¼–è¯‘ï¼ˆTypeScripté¡¹ç›®å¿…é¡»ï¼‰
# ========================================
cd backend
npm run build
cd ..

# ========================================
# æ­¥éª¤6ï¼šé‡æ–°æ„å»ºå’Œéƒ¨ç½²
# ========================================
# æ–¹æ³•Aï¼šä½¿ç”¨docker composeï¼ˆæ¨èï¼‰
docker build -f backend/Dockerfile.simple -t site4:latest ./backend
docker stop site4 && docker rm site4
docker run -d --name site4 --network webproxy --env-file backend/.env --restart unless-stopped site4:latest
docker network connect shared_net site4

# æ–¹æ³•Bï¼šå¦‚æœæœ‰docker-compose.yml
docker compose down
docker compose build --no-cache
docker compose up -d

# ========================================
# æ­¥éª¤7ï¼šéªŒè¯éƒ¨ç½²
# ========================================
sleep 15
docker logs site4 --tail 30
curl http://localhost:3000/health
```

**â±ï¸ æ—¶é—´ä¼°è®¡**ï¼š5-10åˆ†é’Ÿï¼ˆå–å†³äºä»£ç å¤æ‚åº¦ï¼‰

---

### åˆ†ç±»2ï¼šé…ç½®é—®é¢˜ï¼ˆå¯ä»¥VPSç›´æ¥ä¿®æ”¹ï¼‰

**ç‰¹å¾**ï¼š
- åªä¿®æ”¹ `.env` æ–‡ä»¶
- ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼ˆAPIå¯†é’¥ã€æ•°æ®åº“å¯†ç ã€åŸŸåç­‰ï¼‰
- ä¸æ¶‰åŠä»£ç é€»è¾‘ä¿®æ”¹

**âœ… æ­£ç¡®æµç¨‹**ï¼š

```bash
# ========================================
# åœ¨VPSä¸Šç›´æ¥ä¿®æ”¹.envæ–‡ä»¶
# ========================================
ssh root@YOUR_VPS_IP
cd /docker/site4

# ç¼–è¾‘.envæ–‡ä»¶
nano backend/.env
# æˆ–
vim backend/.env

# ä¿®æ”¹å®Œæˆåï¼ŒæŒ‰Ctrl+Oä¿å­˜ï¼ŒCtrl+Xé€€å‡º

# ========================================
# éªŒè¯.envæ–‡ä»¶å†…å®¹
# ========================================
cat backend/.env | grep "ä½ ä¿®æ”¹çš„å˜é‡å"

# ä¾‹å¦‚éªŒè¯CORSé…ç½®
cat backend/.env | grep "ALLOWED_ORIGINS"

# ========================================
# é‡å¯å®¹å™¨ä½¿é…ç½®ç”Ÿæ•ˆ
# ========================================
docker restart site4

# ç­‰å¾…å¯åŠ¨
sleep 15

# ========================================
# éªŒè¯é…ç½®å·²ç”Ÿæ•ˆ
# ========================================
docker logs site4 --tail 30

# éªŒè¯ç‰¹å®šé…ç½®ï¼ˆä¾‹å¦‚CORSï¼‰
docker logs site4 | grep "å…è®¸çš„CORSæº"
```

**â±ï¸ æ—¶é—´ä¼°è®¡**ï¼š2-3åˆ†é’Ÿ

---

### åˆ†ç±»3ï¼šéƒ¨ç½²é—®é¢˜ï¼ˆVPSè¯Šæ–­å’Œä¿®å¤ï¼‰

**ç‰¹å¾**ï¼š
- å®¹å™¨æ— æ³•å¯åŠ¨
- ç½‘ç»œè¿æ¥é—®é¢˜
- æ•°æ®åº“è¿æ¥å¤±è´¥
- å¥åº·æ£€æŸ¥å¤±è´¥

**âœ… è¯Šæ–­æµç¨‹**ï¼š

```bash
# ========================================
# æ­¥éª¤1ï¼šæ£€æŸ¥å®¹å™¨çŠ¶æ€
# ========================================
docker ps -a | grep site4
docker logs site4 --tail 50

# ========================================
# æ­¥éª¤2ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥
# ========================================
docker network ls | grep -E "(webproxy|shared_net)"
docker inspect site4 | grep -A 10 "Networks"

# ========================================
# æ­¥éª¤3ï¼šæ£€æŸ¥æ•°æ®åº“è¿æ¥ï¼ˆå¦‚æœä½¿ç”¨PostgreSQLï¼‰
# ========================================
docker exec site4 nc -zv postgres_master 5432 || echo "æ•°æ®åº“è¿æ¥å¤±è´¥"

# æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æƒé™
cd /docker/db_master
docker compose exec postgres psql -U admin -d postgres -c "\du" | grep site4

# ========================================
# æ­¥éª¤4ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡
# ========================================
docker exec site4 env | grep -E "(DB_|ALLOWED_ORIGINS|NODE_ENV)"

# ========================================
# æ­¥éª¤5ï¼šå¥åº·æ£€æŸ¥
# ========================================
docker exec site4 curl -s http://localhost:3000/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"
```

**å¸¸è§é—®é¢˜å’Œä¿®å¤**ï¼š

#### é—®é¢˜1ï¼šå®¹å™¨å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
docker logs site4 --tail 100

# å¸¸è§åŸå› ï¼š
# 1. ç«¯å£å†²çª â†’ ä¿®æ”¹docker-compose.ymlç«¯å£æ˜ å°„
# 2. .envæ–‡ä»¶ç¼ºå¤± â†’ æ£€æŸ¥backend/.envæ˜¯å¦å­˜åœ¨
# 3. ä¾èµ–å®‰è£…å¤±è´¥ â†’ é‡æ–°æ„å»ºé•œåƒ
```

#### é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network connect shared_net site4

# æ£€æŸ¥æ•°æ®åº“åˆ«å
docker network inspect shared_net | grep -A 5 "postgres_master"

# å¦‚æœæ²¡æœ‰åˆ«åï¼Œè®¾ç½®åˆ«å
docker network disconnect shared_net postgres_master
docker network connect --alias postgres_master shared_net postgres_master
```

#### é—®é¢˜3ï¼šCORSé”™è¯¯ï¼ˆwwwå­åŸŸåè¢«é˜»æ­¢ï¼‰
```bash
# æ£€æŸ¥CORSé…ç½®
docker logs site4 | grep "å…è®¸çš„CORSæº"

# å¦‚æœæ²¡æœ‰çœ‹åˆ°wwwåŸŸåï¼Œä¿®æ”¹.env
nano backend/.env
# ç¡®ä¿ï¼šALLOWED_ORIGINS=https://example.com,https://www.example.com

# é‡å¯å®¹å™¨
docker restart site4

# éªŒè¯
docker logs site4 | grep "www"
```

---

### åˆ†ç±»4ï¼šçº¯Dockeréƒ¨ç½²ç¯å¢ƒï¼ˆVPSæ— Node.jsï¼‰

**ç‰¹å¾**ï¼š
- âœ… VPSåªå®‰è£…Dockerå’ŒDocker Compose
- âœ… ä¸å®‰è£…Node.jsã€npmã€Pythonç­‰å¼€å‘å·¥å…·
- âœ… æ‰€æœ‰æ„å»ºå·¥ä½œåœ¨Dockerå®¹å™¨å†…å®Œæˆ
- âœ… é€‚ç”¨äºçº¯ç”Ÿäº§ç¯å¢ƒçš„VPS

**âš ï¸ å…³é”®åŸåˆ™ï¼šç»å¯¹ä¸è¦åœ¨VPSä¸Šå®‰è£…Node.js/npmï¼**

---

#### âŒ é”™è¯¯æ–¹æ³•ï¼šè¦æ±‚ç”¨æˆ·å®‰è£…npm

**é”™è¯¯åšæ³•**ï¼š
```bash
# VPSæ‰§è¡Œ
apt install npm          # âŒ é”™è¯¯ï¼æ±¡æŸ“VPSç¯å¢ƒ
cd frontend
npm install             # âŒ é”™è¯¯ï¼ä¸åº”è¯¥åœ¨VPSä¸Šæ‰§è¡Œ
npm run build           # âŒ é”™è¯¯ï¼åº”è¯¥åœ¨Dockerå†…æ„å»º
```

**ä¸ºä»€ä¹ˆé”™è¯¯**ï¼š
1. è¿åå®¹å™¨åŒ–åŸåˆ™ï¼ˆç¯å¢ƒä¸ä¸€è‡´ï¼‰
2. VPSç¯å¢ƒæ±¡æŸ“ï¼ˆå¤šä¸ªé¡¹ç›®ä¾èµ–å†²çªï¼‰
3. å®‰å…¨éšæ‚£ï¼ˆå¼€å‘å·¥å…·æš´éœ²åœ¨ç”Ÿäº§ç¯å¢ƒï¼‰
4. ç»´æŠ¤å›°éš¾ï¼ˆå‡çº§Node.jsç‰ˆæœ¬éœ€è¦é‡æ–°é…ç½®VPSï¼‰

---

#### âœ… æ­£ç¡®æ–¹æ³•ï¼šDockerå¤šé˜¶æ®µæ„å»º

**æ ¸å¿ƒæ€è·¯**ï¼š
```
é˜¶æ®µ1: åœ¨Node.jså®¹å™¨å†…æ„å»ºå‰ç«¯
  â†“
é˜¶æ®µ2: å°†æ„å»ºäº§ç‰©å¤åˆ¶åˆ°ç”Ÿäº§å®¹å™¨
  â†“
æœ€ç»ˆé•œåƒ: åªåŒ…å«è¿è¡Œæ—¶ä¾èµ–ï¼Œä¸å«æ„å»ºå·¥å…·
```

**å®Œæ•´éƒ¨ç½²æµç¨‹**ï¼š

```bash
# ========================================
# æ­¥éª¤1ï¼šæ¸…ç†æ—§éƒ¨ç½²
# ========================================
# åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
docker stop site6
docker rm site6

# åˆ é™¤æ—§é•œåƒï¼ˆå¯é€‰ï¼ŒèŠ‚çœç©ºé—´ï¼‰
docker rmi site6:latest

# åˆ é™¤æ—§ä»£ç ç›®å½•
cd /docker
rm -rf site6

# ========================================
# æ­¥éª¤2ï¼šå…‹éš†æœ€æ–°ä»£ç 
# ========================================
git clone https://github.com/USERNAME/REPO.git
mv REPO/site6 .          # æå–site6ç›®å½•
rm -rf REPO              # åˆ é™¤å…¶ä»–ç›®å½•

cd site6

# ========================================
# æ­¥éª¤3ï¼šåˆ›å»ºå¤šé˜¶æ®µDockerfile
# ========================================
# åˆ›å»ºDockerfileï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
cat > Dockerfile << 'EOF'
# ============================================
# é˜¶æ®µ1ï¼šæ„å»ºå‰ç«¯ï¼ˆåœ¨Node.jså®¹å™¨å†…ï¼‰
# ============================================
FROM node:22-alpine AS frontend-builder

WORKDIR /frontend

# å¤åˆ¶å‰ç«¯ä¾èµ–æ–‡ä»¶
COPY frontend/package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --no-audit --no-fund

# å¤åˆ¶å‰ç«¯æºä»£ç 
COPY frontend/ ./

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_PUBLIC_API_BASE_URL=""

# æ„å»ºé™æ€æ–‡ä»¶
RUN npm run build

# ============================================
# é˜¶æ®µ2ï¼šç”Ÿäº§é•œåƒï¼ˆåªåŒ…å«è¿è¡Œæ—¶ï¼‰
# ============================================
FROM node:22-alpine

WORKDIR /app

# å®‰è£…è¿è¡Œæ—¶å·¥å…·
RUN apk add --no-cache curl

# å¤åˆ¶åç«¯ä¾èµ–æ–‡ä»¶
COPY backend/package*.json ./

# åªå®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm ci --omit=dev --no-audit --no-fund && \
    npm cache clean --force

# å¤åˆ¶åç«¯ä»£ç 
COPY backend/ ./

# ä»é˜¶æ®µ1å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
COPY --from=frontend-builder /frontend/out ./public

# åˆ›å»ºå¿…è¦ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p logs cache/diffs && \
    chown -R node:node /app

# ä½¿ç”¨érootç”¨æˆ·
USER node

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["node", "server.js"]
EOF

# ========================================
# æ­¥éª¤4ï¼šæ„å»ºDockeré•œåƒ
# ========================================
# Dockerä¼šè‡ªåŠ¨æ‰§è¡Œä¸¤ä¸ªé˜¶æ®µçš„æ„å»º
docker build -t site6:latest .

# æŸ¥çœ‹æ„å»ºç»“æœ
docker images | grep site6

# ========================================
# æ­¥éª¤5ï¼šå¯åŠ¨å®¹å™¨
# ========================================
# âš ï¸ é‡è¦ï¼šæ‰€æœ‰ç«™ç‚¹éƒ½ä½¿ç”¨å®¹å™¨å†…éƒ¨3000ç«¯å£
# âš ï¸ ä¸è¦ä½¿ç”¨ -p å‚æ•°æš´éœ²ç«¯å£ï¼ˆä¼šå¯¼è‡´ç«¯å£å†²çªï¼‰
# âš ï¸ å¿…é¡»é€šè¿‡NPMåå‘ä»£ç†è®¿é—®

docker run -d \
  --name site6 \
  --network webproxy \
  --restart unless-stopped \
  -e NODE_ENV=production \
  -e ALLOWED_ORIGINS=https://example.com,https://www.example.com \
  site6:latest

# ========================================
# æ­¥éª¤6ï¼šéªŒè¯éƒ¨ç½²
# ========================================
# ç­‰å¾…å®¹å™¨å¯åŠ¨
sleep 10

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep site6

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker logs site6 --tail 30

# å¥åº·æ£€æŸ¥ï¼ˆå®¹å™¨å†…éƒ¨ï¼‰
docker exec site6 curl -s http://localhost:3000/health

# ========================================
# æ­¥éª¤7ï¼šé…ç½®Nginx Proxy Manager
# ========================================
# åœ¨NPMç®¡ç†ç•Œé¢é…ç½®ï¼š
# - Domain Names: example.com, www.example.com
# - Scheme: http
# - Forward Hostname/IP: site6  ï¼ˆå®¹å™¨åï¼Œä¸æ˜¯IPï¼‰
# - Forward Port: 3000
# - å¯ç”¨SSL (Let's Encrypt)
```

---

#### ğŸ“‹ Nginx Proxy Manageræ¶æ„è¯´æ˜

**ç½‘ç»œæ‹“æ‰‘**ï¼š
```
Internet â†’ Nginx Proxy Manager â†’ Docker Network (webproxy) â†’ å„ç«™ç‚¹å®¹å™¨
                â†“
         SSLè¯ä¹¦ç®¡ç†
         åŸŸåè·¯ç”±
         åå‘ä»£ç†
```

**ä¼˜åŠ¿**ï¼š
1. âœ… å®¹å™¨ä¸éœ€è¦æš´éœ²ç«¯å£åˆ°å®¿ä¸»æœº
2. âœ… ç»Ÿä¸€ç®¡ç†SSLè¯ä¹¦
3. âœ… å¤šä¸ªç«™ç‚¹å…±ç”¨80/443ç«¯å£
4. âœ… è‡ªåŠ¨ç»­æœŸLet's Encryptè¯ä¹¦

**å…³é”®é…ç½®**ï¼š
```bash
# æ‰€æœ‰ç«™ç‚¹å®¹å™¨å¿…é¡»åŠ å…¥webproxyç½‘ç»œ
docker network create webproxy  # é¦–æ¬¡åˆ›å»º

# å¯åŠ¨å®¹å™¨æ—¶è¿æ¥åˆ°webproxy
docker run -d \
  --name site6 \
  --network webproxy \     # â† å…³é”®ï¼šåŠ å…¥webproxyç½‘ç»œ
  ...
  site6:latest

# NPMé…ç½®æŒ‡å‘å®¹å™¨åï¼ˆä¸æ˜¯localhostï¼‰
Forward Hostname: site6    # â† å®¹å™¨åï¼Œä¸æ˜¯IP
Forward Port: 3000         # â† å®¹å™¨å†…ç«¯å£

# âš ï¸ å…³é”®ï¼šæ¯ä¸ªå®¹å™¨å†…éƒ¨éƒ½ç›‘å¬3000ç«¯å£
# âš ï¸ ä½†é€šè¿‡å®¹å™¨åéš”ç¦»ï¼Œä¸ä¼šå†²çª
# âš ï¸ NPMæ ¹æ®åŸŸåè·¯ç”±åˆ°ä¸åŒå®¹å™¨
```

---

#### ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­

##### é—®é¢˜1ï¼šç«¯å£å·²è¢«å ç”¨

**é”™è¯¯æ—¥å¿—**ï¼š
```
Error: Bind for 127.0.0.1:3000 failed: port is already allocated
```

**åŸå› **ï¼š
- é”™è¯¯ä½¿ç”¨äº† `-p 3000:3000` å‚æ•°
- VPSä¸Šæ‰€æœ‰ç«™ç‚¹éƒ½ä½¿ç”¨å®¹å™¨å†…éƒ¨3000ç«¯å£
- ä¸èƒ½å°†å¤šä¸ªå®¹å™¨çš„3000ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºåŒä¸€ç«¯å£

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# âš ï¸ å…³é”®ï¼šä¸è¦ä½¿ç”¨ -p å‚æ•°ï¼

# 1. åœæ­¢é”™è¯¯å¯åŠ¨çš„å®¹å™¨
docker stop site6
docker rm site6

# 2. æ­£ç¡®å¯åŠ¨ï¼ˆä¸æ˜ å°„ç«¯å£ï¼‰
docker run -d \
  --name site6 \
  --network webproxy \
  --restart unless-stopped \
  -e NODE_ENV=production \
  -e ALLOWED_ORIGINS=https://example.com,https://www.example.com \
  site6:latest

# 3. åœ¨NPMä¸­é…ç½®åå‘ä»£ç†
# Forward to: site6:3000
```

---

##### é—®é¢˜2ï¼šVPSç›®å½•ä¸æ˜¯Gitä»“åº“

**é”™è¯¯æ—¥å¿—**ï¼š
```
fatal: not a git repository (or any of the parent directories): .git
```

**åŸå› **ï¼š
- ä¹‹å‰å¯èƒ½æ˜¯ç›´æ¥å¤åˆ¶æ–‡ä»¶ï¼Œä¸æ˜¯git clone
- æˆ–.gitç›®å½•è¢«è¯¯åˆ 

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦æ˜¯Gitä»“åº“
cd /docker/site6
ls -la | grep .git

# å¦‚æœæ²¡æœ‰.gitç›®å½•ï¼Œé‡æ–°å…‹éš†
cd /docker
rm -rf site6
git clone https://github.com/USERNAME/REPO.git
mv REPO/site6 .
rm -rf REPO
cd site6
```

---

##### é—®é¢˜3ï¼šå®¹å™¨å¯åŠ¨æˆåŠŸä½†å¥åº·æ£€æŸ¥å¤±è´¥

**ç—‡çŠ¶**ï¼š
```bash
docker ps | grep site6
# æ˜¾ç¤º (unhealthy) æˆ– (starting)
```

**è¯Šæ–­æ­¥éª¤**ï¼š
```bash
# 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs site6 --tail 50

# 2. æ£€æŸ¥å‰ç«¯æ–‡ä»¶æ˜¯å¦å¤åˆ¶æˆåŠŸ
docker exec site6 ls -la /app/public/

# å¦‚æœpublicç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨ â†’ å‰ç«¯æ„å»ºå¤±è´¥

# 3. æ‰‹åŠ¨æ‰§è¡Œå¥åº·æ£€æŸ¥
docker exec site6 curl -v http://localhost:3000/health

# 4. æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec site6 env | grep NODE_ENV
```

**ä¿®å¤æ–¹æ³•**ï¼š
```bash
# å¦‚æœå‰ç«¯æ„å»ºå¤±è´¥ï¼Œæ£€æŸ¥Dockerfile
# ç¡®ä¿COPYæŒ‡ä»¤æ­£ç¡®ï¼š
# COPY --from=frontend-builder /frontend/out ./public

# é‡æ–°æ„å»º
docker stop site6 && docker rm site6
docker rmi site6:latest
docker build -t site6:latest .
docker run -d --name site6 --network webproxy ...
```

---

#### ğŸ“¦ Dockerfileæœ€ä½³å®è·µ

**å‰ç«¯æ„å»ºé˜¶æ®µä¼˜åŒ–**ï¼š
```dockerfile
# ä½¿ç”¨alpineé•œåƒå‡å°ä½“ç§¯
FROM node:22-alpine AS frontend-builder

# å…ˆå¤åˆ¶package.jsonï¼Œåˆ©ç”¨Dockerç¼“å­˜
COPY frontend/package*.json ./
RUN npm ci --no-audit --no-fund

# å†å¤åˆ¶æºä»£ç ï¼ˆä»£ç å˜åŠ¨é¢‘ç¹ï¼‰
COPY frontend/ ./

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_PUBLIC_API_BASE_URL=""

# æ„å»º
RUN npm run build

# âš ï¸ ç¡®è®¤è¾“å‡ºç›®å½•åç§°
# Next.js: out/ æˆ– .next/
# Vite: dist/
# æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ COPY æŒ‡ä»¤
```

**ç”Ÿäº§é•œåƒé˜¶æ®µä¼˜åŒ–**ï¼š
```dockerfile
FROM node:22-alpine

# å®‰è£…å¿…è¦å·¥å…·
RUN apk add --no-cache curl  # å¥åº·æ£€æŸ¥éœ€è¦

# åªå®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm ci --omit=dev --no-audit --no-fund && \
    npm cache clean --force

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶äº§ç‰©
COPY --from=frontend-builder /frontend/out ./public

# å®‰å…¨ï¼šä½¿ç”¨érootç”¨æˆ·
USER node

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1
```

---

#### ğŸ¯ Site6 (Txtmoji) å®æˆ˜æ¡ˆä¾‹

**é¡¹ç›®æ¶æ„**ï¼š
- å‰ç«¯ï¼šNext.js 14 (é™æ€å¯¼å‡º)
- åç«¯ï¼šExpress.js (Node.js 22)
- éƒ¨ç½²ï¼šNginx Proxy Manager + Docker
- åŸŸåï¼štexttoemojis.online

**éƒ¨ç½²è¿‡ç¨‹**ï¼š

**é—®é¢˜1ï¼šVPSä¸Šæ‰§è¡Œnpm installå¤±è´¥**
```
root@vps:/docker/site6/frontend# npm install
Command 'npm' not found, but can be installed with:
apt install npm
```

âŒ **é”™è¯¯è§£å†³æ–¹å¼**ï¼š
```bash
apt install npm  # ä¸è¦è¿™æ ·åšï¼
```

âœ… **æ­£ç¡®è§£å†³æ–¹å¼**ï¼š
```bash
# ä½¿ç”¨Dockerå¤šé˜¶æ®µæ„å»º
cd /docker/site6
cat > Dockerfile << 'EOF'
FROM node:22-alpine AS frontend-builder
WORKDIR /frontend
COPY frontend/package*.json ./
RUN npm ci --no-audit --no-fund
COPY frontend/ ./
ENV NODE_ENV=production
RUN npm run build

FROM node:22-alpine
WORKDIR /app
COPY backend/package*.json ./
RUN npm ci --omit=dev
COPY backend/ ./
COPY --from=frontend-builder /frontend/out ./public
USER node
EXPOSE 3000
CMD ["node", "server.js"]
EOF

docker build -t site6:latest .
```

**é—®é¢˜2ï¼šç«¯å£3000è¢«å ç”¨**

é”™è¯¯åŸå› æ˜¯ä½¿ç”¨äº† `-p 3000:3000` å‚æ•°æ˜ å°„ç«¯å£ã€‚

âœ… **è§£å†³æ–¹æ¡ˆ**ï¼šå‚è§å‰æ–‡"é—®é¢˜1ï¼šç«¯å£å·²è¢«å ç”¨"çš„è¯¦ç»†è¯´æ˜ï¼ˆç¬¬502-533è¡Œï¼‰ã€‚

ç®€è¦æ­¥éª¤ï¼š
1. åœæ­¢å®¹å™¨ï¼š`docker stop site6 && docker rm site6`
2. é‡æ–°å¯åŠ¨ï¼ˆä¸ä½¿ç”¨-på‚æ•°ï¼‰
3. åœ¨NPMä¸­é…ç½®åå‘ä»£ç†ï¼š`site6:3000`

**éƒ¨ç½²æ—¶é—´**ï¼š
- âœ… ä½¿ç”¨Dockerå¤šé˜¶æ®µæ„å»ºï¼š15åˆ†é’Ÿ
- âŒ å°è¯•å®‰è£…npmæ‰‹åŠ¨æ„å»ºï¼šæ— æ³•å®Œæˆ

---

## ğŸš« AIå¿…é¡»é¿å…çš„é”™è¯¯è¡Œä¸º

### âŒ é”™è¯¯1ï¼šè¦æ±‚ç”¨æˆ·æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶

**é”™è¯¯åšæ³•**ï¼š
```
AI: "è¯·å°†ä¿®æ”¹åçš„ index.ts æ‰‹åŠ¨ä¸Šä¼ åˆ°VPSçš„ /docker/site4/backend/src/ ç›®å½•"
```

**âœ… æ­£ç¡®åšæ³•**ï¼š
```
AI: 
1. æˆ‘å·²åœ¨æœ¬åœ°ä¿®æ”¹äº† backend/src/index.ts
2. æˆ‘å°†æäº¤åˆ°GitHub
3. è¯·åœ¨VPSæ‰§è¡Œï¼š
   cd /docker/site4
   git pull origin main
   cd backend && npm run build && cd ..
   docker build -f backend/Dockerfile.simple -t site4:latest ./backend
   docker restart site4
```

---

### âŒ é”™è¯¯2ï¼šè®©ç”¨æˆ·åœ¨VPSç›´æ¥ä¿®æ”¹ä»£ç 

**é”™è¯¯åšæ³•**ï¼š
```
AI: "è¯·åœ¨VPSæ‰§è¡Œï¼š
     nano /docker/site4/backend/src/index.ts
     ç„¶åæ·»åŠ ä»¥ä¸‹ä»£ç ..."
```

**ä¸ºä»€ä¹ˆé”™è¯¯**ï¼š
- æ— æ³•éªŒè¯è¯­æ³•é”™è¯¯
- æ— æ³•æäº¤åˆ°Git
- TypeScriptæ— æ³•ç¼–è¯‘
- å®¹æ˜“å‡ºé”™ä¸”éš¾ä»¥å›æ»š

**âœ… æ­£ç¡®åšæ³•**ï¼š
```
AI: 
è¿™æ˜¯ä»£ç ä¿®æ”¹ï¼Œéœ€è¦åœ¨æœ¬åœ°å®Œæˆï¼š
1. æˆ‘åœ¨æœ¬åœ°ä¿®æ”¹ backend/src/index.ts
2. æœ¬åœ°ç¼–è¯‘ï¼šnpm run build
3. Gitæäº¤å¹¶æ¨é€
4. VPSæ‹‰å–å¹¶é‡æ–°éƒ¨ç½²
```

---

### âŒ é”™è¯¯3ï¼šé‡å¤æ— æ•ˆå‘½ä»¤

**é”™è¯¯åšæ³•**ï¼š
```
ç”¨æˆ·ï¼š"è¿˜æ˜¯500é”™è¯¯"
AIï¼š"å†è¯•è¯• docker restart site4"
ç”¨æˆ·ï¼š"è¿˜æ˜¯500é”™è¯¯"
AIï¼š"å†è¯•è¯• docker compose up -d --build"
ç”¨æˆ·ï¼š"è¿˜æ˜¯500é”™è¯¯"
AIï¼š"å†è¯•è¯•..."  â† æ— é™å¾ªç¯
```

**âœ… æ­£ç¡®åšæ³•**ï¼š
```
AI:
é‡å¯æ— æ•ˆï¼Œè¯´æ˜æ˜¯é…ç½®æˆ–ä»£ç é—®é¢˜ã€‚è®©æˆ‘ä»¬è¯Šæ–­ï¼š
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼šdocker logs site4 --tail 50
2. æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼šdocker exec site4 env | grep API
3. æ ¹æ®æ—¥å¿—ç¡®å®šé—®é¢˜ç±»å‹ï¼š
   - å¦‚æœæ˜¯ä»£ç é”™è¯¯ â†’ éœ€è¦æœ¬åœ°ä¿®æ”¹ä»£ç 
   - å¦‚æœæ˜¯é…ç½®é”™è¯¯ â†’ ä¿®æ”¹.envæ–‡ä»¶
   - å¦‚æœæ˜¯æƒé™é”™è¯¯ â†’ æ£€æŸ¥æ•°æ®åº“æƒé™
```

---

## ğŸ“‹ æ ‡å‡†åŒ–é—®é¢˜å¤„ç†æ£€æŸ¥æ¸…å•

### æ”¶åˆ°é—®é¢˜æŠ¥å‘Šæ—¶ï¼ŒAIå¿…é¡»å…ˆé—®ï¼š

```markdown
## é—®é¢˜è¯Šæ–­æ£€æŸ¥æ¸…å•

### 1. è·å–é”™è¯¯æ—¥å¿—
[ ] å®¹å™¨æ—¥å¿—ï¼šdocker logs site4 --tail 50
[ ] æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯æˆªå›¾
[ ] ç½‘ç»œè¯·æ±‚é”™è¯¯ï¼ˆå¦‚CORSé”™è¯¯ï¼‰

### 2. ç¡®å®šé—®é¢˜ç±»å‹
[ ] ä»£ç é—®é¢˜ï¼ˆéœ€è¦ä¿®æ”¹.ts/.jsæ–‡ä»¶ï¼‰â†’ èµ°"ä»£ç ä¿®æ”¹æµç¨‹"
[ ] é…ç½®é—®é¢˜ï¼ˆåªéœ€ä¿®æ”¹.envï¼‰â†’ èµ°"é…ç½®ä¿®æ”¹æµç¨‹"  
[ ] éƒ¨ç½²é—®é¢˜ï¼ˆå®¹å™¨ã€ç½‘ç»œã€æ•°æ®åº“ï¼‰â†’ èµ°"è¯Šæ–­æµç¨‹"

### 3. éªŒè¯å½“å‰çŠ¶æ€
[ ] å®¹å™¨æ˜¯å¦è¿è¡Œï¼šdocker ps | grep site4
[ ] GitçŠ¶æ€ï¼šgit statusï¼ˆæœ‰æ— æœªæäº¤ä¿®æ”¹ï¼‰
[ ] ç¼–è¯‘çŠ¶æ€ï¼šls backend/dist/ï¼ˆTypeScripté¡¹ç›®ï¼‰
[ ] ç¯å¢ƒå˜é‡ï¼šcat backend/.env | head -10

### 4. é€‰æ‹©æ­£ç¡®æµç¨‹
æ ¹æ®é—®é¢˜ç±»å‹ï¼Œé€‰æ‹©ä¸Šè¿°å¯¹åº”çš„æµç¨‹æ‰§è¡Œ
```

---

## ğŸ¯ ColorMagic (Site4) å®æˆ˜æ¡ˆä¾‹æ€»ç»“

### æ¡ˆä¾‹ï¼šwwwå­åŸŸåè¢«CORSé˜»æ­¢

**é—®é¢˜ç°è±¡**ï¼š
- âœ… https://imagecolorpicker.cc æ­£å¸¸
- âŒ https://www.imagecolorpicker.cc è¿”å›500é”™è¯¯
- âŒ æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºCORSé”™è¯¯

**é”™è¯¯çš„å¤„ç†æ–¹å¼ï¼ˆæ—§ç‰ˆæŒ‡å—ï¼‰**ï¼š
```bash
âŒ ç›´æ¥åœ¨VPSä¿®æ”¹ backend/src/index.ts
âŒ è®©ç”¨æˆ·æ‰‹åŠ¨ä¸Šä¼ ä¿®æ”¹åçš„æ–‡ä»¶
âŒ é‡å¤æ‰§è¡Œ docker restartï¼ˆæ— æ•ˆï¼‰
```

**âœ… æ­£ç¡®çš„å¤„ç†æ–¹å¼**ï¼š

**æ­¥éª¤1ï¼šæœ¬åœ°ä¿®æ”¹ä»£ç **
```typescript
// backend/src/index.ts
const getAllowedOrigins = (): (string | RegExp)[] => {
  const origins: (string | RegExp)[] = []
  
  // æ–°å¢ï¼šè¯»å–ALLOWED_ORIGINSç¯å¢ƒå˜é‡
  if (process.env.ALLOWED_ORIGINS) {
    const allowedOriginsArray = process.env.ALLOWED_ORIGINS.split(',').map(o => o.trim())
    origins.push(...allowedOriginsArray)
  }
  
  return origins
}
```

**æ­¥éª¤2ï¼šæœ¬åœ°ç¼–è¯‘**
```bash
cd backend
npm run build
grep "ALLOWED_ORIGINS" dist/index.js  # éªŒè¯ç¼–è¯‘æˆåŠŸ
```

**æ­¥éª¤3ï¼šGitæäº¤**
```bash
git add backend/src/index.ts backend/dist/index.js
git commit -m "fix: add ALLOWED_ORIGINS environment variable support"
git push origin main
```

**æ­¥éª¤4ï¼šVPSéƒ¨ç½²**
```bash
cd /docker/site4
git pull origin main
cd backend && npm run build && cd ..
docker build -f backend/Dockerfile.simple -t site4:latest ./backend
docker stop site4 && docker rm site4
docker run -d --name site4 --network webproxy --env-file backend/.env --restart unless-stopped site4:latest
docker network connect shared_net site4
```

**æ­¥éª¤5ï¼šé…ç½®.env**
```bash
nano backend/.env
# æ·»åŠ ï¼šALLOWED_ORIGINS=https://imagecolorpicker.cc,https://www.imagecolorpicker.cc
docker restart site4
```

**æ­¥éª¤6ï¼šéªŒè¯**
```bash
docker logs site4 | grep "å…è®¸çš„CORSæº"
curl -I https://imagecolorpicker.cc
curl -I https://www.imagecolorpicker.cc
```

**ç»“æœ**ï¼šâœ… é—®é¢˜è§£å†³ï¼Œä¸¤ä¸ªåŸŸåéƒ½æ­£å¸¸è®¿é—®

**æ—¶é—´å¯¹æ¯”**ï¼š
- âŒ é”™è¯¯æ–¹å¼ï¼šå¤šæ¬¡å¤±è´¥ï¼Œè€—æ—¶3å°æ—¶+
- âœ… æ­£ç¡®æ–¹å¼ï¼šä¸€æ¬¡æˆåŠŸï¼Œè€—æ—¶15åˆ†é’Ÿ

---

## ğŸ”„ Gitå·¥ä½œæµç¨‹æœ€ä½³å®è·µ

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# åˆå§‹è®¾ç½®
cd ~/Documents/GitHub/Image-Color-Analysis
git config user.name "Your Name"
git config user.email "your.email@example.com"

# æ—¥å¸¸å¼€å‘æµç¨‹
git pull origin main                    # æ‹‰å–æœ€æ–°ä»£ç 
# ... ä¿®æ”¹ä»£ç  ...
npm run build                          # ç¼–è¯‘ï¼ˆå¦‚éœ€è¦ï¼‰
git status                             # æŸ¥çœ‹ä¿®æ”¹
git add .                              # æ·»åŠ ä¿®æ”¹
git commit -m "æè¿°ä½ çš„ä¿®æ”¹"            # æäº¤
git push origin main                   # æ¨é€åˆ°GitHub
```

### VPSéƒ¨ç½²ç¯å¢ƒ

```bash
# åˆå§‹è®¾ç½®
cd /docker/site4
git config --global user.name "VPS Deployment"
git config --global user.email "deploy@vps.local"

# æ—¥å¸¸éƒ¨ç½²æµç¨‹
cp backend/.env backend/.env.backup    # å¤‡ä»½.env
git stash                              # æš‚å­˜æœ¬åœ°ä¿®æ”¹
git pull origin main                   # æ‹‰å–æœ€æ–°ä»£ç 
git stash pop                          # æ¢å¤æœ¬åœ°ä¿®æ”¹
cp backend/.env.backup backend/.env    # æ¢å¤.env

# å¦‚æœæœ‰å†²çª
git stash drop                         # ä¸¢å¼ƒæš‚å­˜
git pull origin main                   # é‡æ–°æ‹‰å–
# æ‰‹åŠ¨æ¢å¤.envæ–‡ä»¶

# é‡æ–°éƒ¨ç½²...
```

---

## ğŸ“š å¿«é€Ÿå‚è€ƒå¡ç‰‡

### ä»£ç ä¿®æ”¹ï¼ˆ5æ­¥æµç¨‹ï¼‰

```
æœ¬åœ°ä¿®æ”¹ â†’ æœ¬åœ°ç¼–è¯‘ â†’ Gitæäº¤ â†’ VPSæ‹‰å– â†’ VPSéƒ¨ç½²
```

### é…ç½®ä¿®æ”¹ï¼ˆ3æ­¥æµç¨‹ï¼‰

```
VPSç¼–è¾‘.env â†’ é‡å¯å®¹å™¨ â†’ éªŒè¯ç”Ÿæ•ˆ
```

### é—®é¢˜è¯Šæ–­ï¼ˆ4æ­¥æµç¨‹ï¼‰

```
æŸ¥çœ‹æ—¥å¿— â†’ ç¡®å®šç±»å‹ â†’ é€‰æ‹©æµç¨‹ â†’ æ‰§è¡Œä¿®å¤
```

---

## âš ï¸ AIå·¥ä½œåŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

### 1. ä»£ç ä¿®æ”¹åŸåˆ™
âœ… **DO**ï¼š
- åœ¨æœ¬åœ°ä¿®æ”¹ä»£ç æ–‡ä»¶
- æœ¬åœ°ç¼–è¯‘TypeScript
- é€šè¿‡GitåŒæ­¥åˆ°VPS

âŒ **DON'T**ï¼š
- è®©ç”¨æˆ·åœ¨VPSç›´æ¥ä¿®æ”¹ä»£ç 
- è®©ç”¨æˆ·æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶
- è·³è¿‡ç¼–è¯‘æ­¥éª¤

### 2. é—®é¢˜è¯Šæ–­åŸåˆ™
âœ… **DO**ï¼š
- å…ˆæŸ¥çœ‹æ—¥å¿—ç¡®å®šé—®é¢˜
- æ ¹æ®æ—¥å¿—é€‰æ‹©æ­£ç¡®æµç¨‹
- ä¸€æ¬¡æ€§ç»™å‡ºå®Œæ•´è§£å†³æ–¹æ¡ˆ

âŒ **DON'T**ï¼š
- ä¸çœ‹æ—¥å¿—å°±ç»™å‘½ä»¤
- é‡å¤æ‰§è¡Œæ— æ•ˆå‘½ä»¤
- çŒœæµ‹é—®é¢˜åŸå› 

### 3. æ²Ÿé€šåŸåˆ™
âœ… **DO**ï¼š
- æ˜ç¡®è¯´æ˜ä¸ºä»€ä¹ˆè¿™æ ·åš
- æä¾›å®Œæ•´çš„å‘½ä»¤åºåˆ—
- è¯´æ˜é¢„æœŸç»“æœ

âŒ **DON'T**ï¼š
- åªç»™å‘½ä»¤ä¸è§£é‡Š
- åˆ†æ•£ç»™å‡ºå¤šæ¬¡å‘½ä»¤
- ä¸éªŒè¯ç»“æœ

---

## ğŸ“Š æˆåŠŸç‡ç»Ÿè®¡

| æ–¹æ³• | æˆåŠŸç‡ | å¹³å‡è€—æ—¶ |
|------|--------|----------|
| âœ… æœ¬åœ°ä¿®æ”¹+GitåŒæ­¥ | 95%+ | 15åˆ†é’Ÿ |
| âŒ VPSç›´æ¥ä¿®æ”¹ä»£ç  | 30% | 2å°æ—¶+ |
| âŒ æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶ | 50% | 1å°æ—¶+ |

---

---

## ğŸ¯ TooliBox å®æˆ˜æ¡ˆä¾‹ï¼šNext.js + next-intl éƒ¨ç½²é—®é¢˜

### é¡¹ç›®æ¶æ„
- å‰ç«¯ï¼šNext.js 14 + next-intlï¼ˆå›½é™…åŒ–ï¼‰
- åç«¯ï¼šExpress.js
- éƒ¨ç½²ï¼šPM2 + Nginx
- ç‰¹ç‚¹ï¼šä½¿ç”¨åŠ¨æ€æ¸²æŸ“ï¼ˆéé™æ€å¯¼å‡ºï¼‰

---

### é—®é¢˜ç°è±¡

**ç—‡çŠ¶**ï¼š
```bash
pm2 status
â”‚ toolibox-frontend  â”‚ fork     â”‚ 15   â”‚ errored   â”‚ 0%       â”‚ 0b       â”‚
```

**é”™è¯¯æ—¥å¿—**ï¼š
```
Error: ENOENT: no such file or directory, open '/var/www/toolibox/frontend/.next/prerender-manifest.json'
```

**PM2æ—¥å¿—æ˜¾ç¤º**ï¼š
- å¯åŠ¨æ˜¾ç¤ºæ­£å¸¸ï¼š`âœ“ Starting... â–² Next.js 14.2.33 - Local: http://localhost:3004`
- ä½†éšå³å´©æºƒé‡å¯
- é‡å¯15æ¬¡åè¿›å…¥ `errored` çŠ¶æ€

---

### æ ¹æœ¬åŸå› åˆ†æ

#### 1. Next.js + next-intl çš„åŠ¨æ€æ¸²æŸ“ç‰¹æ€§

**é—®é¢˜é“¾æ¡**ï¼š
```
next-intl ä½¿ç”¨ headers() API
    â†“
æ— æ³•é™æ€é¢„æ¸²æŸ“
    â†“
æ„å»ºæ—¶å°è¯•é™æ€å¯¼å‡ºä½†å¤±è´¥
    â†“
prerender-manifest.json æœªç”Ÿæˆ
    â†“
next start å¯åŠ¨æ—¶æ‰¾ä¸åˆ°å¿…éœ€æ–‡ä»¶
    â†“
åº”ç”¨å´©æºƒ
```

#### 2. æ„å»ºæ—¥å¿—åˆ†æ

```bash
npm run build 2>&1 | grep -i "error\|prerender"

# è¾“å‡ºï¼š
Error occurred prerendering page "/en/terms"
Error: Usage of next-intl APIs in Server Components currently opts into dynamic rendering
Dynamic server usage: Route /zh/terms couldn't be rendered statically because it used `headers`
> Export encountered errors on following paths:
```

**å…³é”®ä¿¡æ¯**ï¼š
- âœ… æ„å»ºæœ¬èº«æˆåŠŸï¼ˆç”Ÿæˆäº† .next/server/ ç›®å½•ï¼‰
- âŒ é™æ€å¯¼å‡ºå¤±è´¥ï¼ˆæŸäº›é¡µé¢æ— æ³•é¢„æ¸²æŸ“ï¼‰
- âŒ prerender-manifest.json æœªç”Ÿæˆ

---

### âœ… è§£å†³æ–¹æ¡ˆï¼ˆå¿«é€Ÿä¿®å¤ï¼‰

#### æ­¥éª¤1ï¼šæ‰‹åŠ¨åˆ›å»ºç¼ºå¤±æ–‡ä»¶

```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd /var/www/toolibox/frontend

# åˆ›å»ºæœ€å°æœ‰æ•ˆçš„ prerender-manifest.json
echo '{"version":4,"routes":{},"dynamicRoutes":{},"preview":{"previewModeId":"__prerender_bypass","previewModeSigningKey":"","previewModeEncryptionKey":""}}' > .next/prerender-manifest.json

# éªŒè¯æ–‡ä»¶å·²åˆ›å»º
ls -la .next/prerender-manifest.json
```

#### æ­¥éª¤2ï¼šå¯åŠ¨åº”ç”¨

```bash
# åˆ é™¤æ—§çš„é”™è¯¯è¿›ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
pm2 delete toolibox-frontend 2>/dev/null || true

# ä½¿ç”¨æŒ‡å®šç«¯å£å¯åŠ¨ï¼ˆæ³¨æ„æ˜¯ "-- start" ä¸æ˜¯ "--start"ï¼‰
PORT=3004 pm2 start npm --name toolibox-frontend -- start

# ç­‰å¾…å¯åŠ¨
sleep 5

# æ£€æŸ¥çŠ¶æ€
pm2 status
```

#### æ­¥éª¤3ï¼šéªŒè¯è¿è¡Œ

```bash
# 1. PM2 çŠ¶æ€åº”è¯¥æ˜¯ online
pm2 status | grep toolibox-frontend

# 2. æµ‹è¯• HTTP å“åº”
curl -I http://localhost:3004
# é¢„æœŸè¾“å‡ºï¼šHTTP/1.1 200 OK

# 3. æŸ¥çœ‹æ—¥å¿—ï¼ˆç¡®è®¤æ— é”™è¯¯ï¼‰
pm2 logs toolibox-frontend --lines 20 --nostream

# 4. ä¿å­˜ PM2 é…ç½®
pm2 save
```

---

### éªŒè¯æˆåŠŸæ ‡å¿—

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ |
|--------|---------|
| PM2 çŠ¶æ€ | `online`ï¼ˆä¸æ˜¯ `errored`ï¼‰ |
| é‡å¯æ¬¡æ•° | `0`ï¼ˆä¸æ˜¯ `15`ï¼‰ |
| HTTP å“åº” | `HTTP/1.1 200 OK` |
| ç«¯å£ç›‘å¬ | `netstat -tulpn \| grep 3004` æœ‰è¾“å‡º |
| æ—¥å¿— | æ—  `ENOENT` é”™è¯¯ |

---

### ä¸ºä»€ä¹ˆè¿™æ ·æœ‰æ•ˆï¼Ÿ

**åŸç†è§£é‡Š**ï¼š

1. **æ„å»ºæˆåŠŸä½†ä¸å®Œæ•´**
   - `.next/server/` ç›®å½•åŒ…å«å®Œæ•´çš„ SSR ä»£ç 
   - é™æ€å¯¼å‡ºå¤±è´¥ä¸å½±å“ SSR è¿è¡Œ
   - ä½† Next.js å¯åŠ¨æ—¶å¼ºåˆ¶è¦æ±‚ `prerender-manifest.json` å­˜åœ¨

2. **æ‰‹åŠ¨åˆ›å»ºç©ºæ¸…å•**
   - æ–‡ä»¶æ ¼å¼ï¼šæ ‡å‡†çš„ JSON ç»“æ„
   - `routes: {}` - æ— é™æ€è·¯ç”±ï¼ˆå› ä¸ºæ˜¯åŠ¨æ€æ¸²æŸ“ï¼‰
   - `dynamicRoutes: {}` - æ— åŠ¨æ€è·¯ç”±é¢„æ¸²æŸ“
   - è¿™æ˜¯æœ€å°æœ‰æ•ˆé…ç½®ï¼Œæ»¡è¶³å¯åŠ¨æ£€æŸ¥

3. **SSR æ¨¡å¼è¿è¡Œ**
   - ä¸ä¾èµ–é¢„æ¸²æŸ“
   - æ¯æ¬¡è¯·æ±‚åŠ¨æ€ç”Ÿæˆ HTML
   - next-intl æ­£å¸¸å·¥ä½œ

---

### å¸¸è§é”™è¯¯å’Œä¿®å¤

#### é”™è¯¯1ï¼šPM2 å¯åŠ¨å‘½ä»¤æ ¼å¼é”™è¯¯

**é”™è¯¯åšæ³•**ï¼š
```bash
pm2 start npm --name toolibox-frontend --start        # âŒ é”™è¯¯
pm2 start npm --name toolibox-frontend - start        # âŒ é”™è¯¯ï¼ˆå•ç ´æŠ˜å·ï¼‰
pm2 start npm --name toolibox-frontend --             # âŒ é”™è¯¯ï¼ˆç¼ºå°‘ startï¼‰
```

**âœ… æ­£ç¡®åšæ³•**ï¼š
```bash
pm2 start npm --name toolibox-frontend -- start       # âœ… æ­£ç¡®ï¼ˆä¸¤ä¸ªç ´æŠ˜å·ç©ºæ ¼startï¼‰
```

**è®°å¿†æ–¹æ³•**ï¼š
- `--` = PM2 å‚æ•°ç»“æŸæ ‡è®°
- åé¢æ˜¯ä¼ é€’ç»™ npm çš„å‚æ•°
- ç­‰ä»·äº `npm start`

---

#### é”™è¯¯2ï¼šæ¯æ¬¡é‡æ–°æ„å»ºåæ–‡ä»¶ä¸¢å¤±

**ç°è±¡**ï¼š
```bash
npm run build
# prerender-manifest.json è¢«åˆ é™¤

npm start
# åˆæŠ¥ ENOENT é”™è¯¯
```

**è§£å†³æ–¹æ¡ˆAï¼šè‡ªåŠ¨åŒ–è„šæœ¬**
```bash
# åˆ›å»ºéƒ¨ç½²è„šæœ¬
cat > deploy.sh << 'EOF'
#!/bin/bash
npm run build
echo '{"version":4,"routes":{},"dynamicRoutes":{},"preview":{"previewModeId":"__prerender_bypass","previewModeSigningKey":"","previewModeEncryptionKey":""}}' > .next/prerender-manifest.json
pm2 restart toolibox-frontend
EOF

chmod +x deploy.sh

# ä½¿ç”¨è„šæœ¬éƒ¨ç½²
./deploy.sh
```

**è§£å†³æ–¹æ¡ˆBï¼šPM2 ç”Ÿæ€ç³»ç»Ÿé…ç½®**
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'toolibox-frontend',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/toolibox/frontend',
    env: {
      PORT: 3004,
      NODE_ENV: 'production'
    },
    // å¯åŠ¨å‰è‡ªåŠ¨åˆ›å»ºæ–‡ä»¶
    pre_deploy_local: "echo '{}' > .next/prerender-manifest.json"
  }]
}
```

---

### é•¿æœŸè§£å†³æ–¹æ¡ˆï¼ˆæ ¹æ²»ï¼‰

#### æ–¹æ¡ˆ1ï¼šä¿®å¤ next-intl é™æ€æ¸²æŸ“é—®é¢˜

**æœ¬åœ°ä¿®æ”¹ä»£ç **ï¼š

```typescript
// frontend/src/app/[locale]/layout.tsx
import { setRequestLocale } from 'next-intl/server';

export default async function LocaleLayout({
  children,
  params: { locale }
}: {
  children: ReactNode;
  params: { locale: string };
}) {
  // æ·»åŠ è¿™ä¸€è¡Œï¼Œå¯ç”¨é™æ€æ¸²æŸ“
  setRequestLocale(locale);

  const messages = await getMessages();
  // ... å…¶ä½™ä»£ç 
}
```

**éƒ¨ç½²æµç¨‹**ï¼š
```bash
# æœ¬åœ°æäº¤
git add frontend/src/app/[locale]/layout.tsx
git commit -m "fix: add setRequestLocale for static rendering"
git push origin main

# VPS æ‹‰å–
cd /var/www/toolibox/frontend
git pull origin main
npm run build
pm2 restart toolibox-frontend
```

---

#### æ–¹æ¡ˆ2ï¼šæ”¹ä¸ºé™æ€å¯¼å‡ºï¼ˆä¸ site1/2/3 ä¸€è‡´ï¼‰

**ä¼˜ç‚¹**ï¼š
- æ— éœ€ Node.js è¿›ç¨‹ï¼ˆèŠ‚çœèµ„æºï¼‰
- Nginx ç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
- éƒ¨ç½²æ›´ç®€å•

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¿®æ”¹ä»£ç ï¼ˆç§»é™¤ `headers()` ç­‰åŠ¨æ€APIï¼‰
- å¤±å» SSR ä¼˜åŠ¿
- å›½é™…åŒ–è·¯ç”±éœ€è¦é‡æ–°è®¾è®¡

**ä¿®æ”¹æ­¥éª¤**ï¼š
1. æœ¬åœ°ä¿®æ”¹ `next.config.js` æ·»åŠ  `output: 'export'`
2. ä¿®æ”¹æ‰€æœ‰ä½¿ç”¨åŠ¨æ€APIçš„é¡µé¢
3. æœ¬åœ°æµ‹è¯• `npm run build`
4. æäº¤åˆ° Git
5. VPS éƒ¨ç½²åˆ° Nginx é™æ€ç›®å½•

---

### éƒ¨ç½²æ—¶é—´å¯¹æ¯”

| æ–¹æ³• | é¦–æ¬¡éƒ¨ç½² | åç»­éƒ¨ç½² | èµ„æºå ç”¨ |
|------|---------|---------|---------|
| âœ… å¿«é€Ÿä¿®å¤ï¼ˆæœ¬æ–¹æ¡ˆï¼‰ | 5åˆ†é’Ÿ | 2åˆ†é’Ÿ | 70MB å†…å­˜ |
| âš ï¸ ä»£ç ä¿®å¤ï¼ˆæ–¹æ¡ˆ1ï¼‰ | 30åˆ†é’Ÿ | 10åˆ†é’Ÿ | 70MB å†…å­˜ |
| âš ï¸ é™æ€å¯¼å‡ºï¼ˆæ–¹æ¡ˆ2ï¼‰ | 2å°æ—¶ | 5åˆ†é’Ÿ | 0MBï¼ˆNginxæœåŠ¡ï¼‰ |

---

### æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’**ï¼š

1. **ä¸è¦æäº¤ prerender-manifest.json åˆ° Git**
   - è¿™æ˜¯æ„å»ºäº§ç‰©ï¼Œä¸æ˜¯æºä»£ç 
   - æ·»åŠ åˆ° `.gitignore`ï¼š`frontend/.next/`

2. **ä¸è¦è¯¯åˆ å…¶ä»–ç«™ç‚¹è¿›ç¨‹**
   ```bash
   # âŒ å±é™©å‘½ä»¤
   pm2 delete all

   # âœ… åªåˆ é™¤ç›®æ ‡è¿›ç¨‹
   pm2 delete toolibox-frontend
   ```

3. **ç«¯å£ä¸è¦å†²çª**
   - site1-backend: é€šå¸¸ 3001
   - site2-backend: é€šå¸¸ 3002
   - site3-backend: é€šå¸¸ 3003
   - toolibox-api: 8000
   - toolibox-frontend: 3004

---

### å®Œæ•´éƒ¨ç½²æ£€æŸ¥æ¸…å•

```bash
# ========================================
# éƒ¨ç½²å‰æ£€æŸ¥
# ========================================
[ ] VPS å·²æ‹‰å–æœ€æ–°ä»£ç ï¼šgit pull origin main
[ ] ä¾èµ–å·²å®‰è£…ï¼šnpm install --production
[ ] å·²æ„å»ºï¼šnpm run build
[ ] .next/server/ ç›®å½•å­˜åœ¨
[ ] prerender-manifest.json å·²åˆ›å»º

# ========================================
# å¯åŠ¨æ£€æŸ¥
# ========================================
[ ] PM2 è¿›ç¨‹çŠ¶æ€ï¼šonline
[ ] ç«¯å£ç›‘å¬ï¼šnetstat -tulpn | grep 3004
[ ] HTTP å“åº”ï¼šcurl http://localhost:3004
[ ] æ—¥å¿—æ— é”™è¯¯ï¼špm2 logs toolibox-frontend

# ========================================
# ä¿å­˜é…ç½®
# ========================================
[ ] PM2 é…ç½®å·²ä¿å­˜ï¼špm2 save
[ ] Nginx é…ç½®å·²æ›´æ–°ï¼ˆä¸‹ä¸€æ­¥ï¼‰
```

---

**æœ€åæ›´æ–°**ï¼š2025-12-10
**ç‰ˆæœ¬**ï¼šv3.1
**çŠ¶æ€**ï¼šåŸºäº Site4ã€Site6 å’Œ TooliBox å®æˆ˜éªŒè¯
**æ–°å¢å†…å®¹**ï¼šNext.js + next-intl éƒ¨ç½²é—®é¢˜ä¿®å¤ã€PM2 å¯åŠ¨å‘½ä»¤è¯¦è§£ã€prerender-manifest.json ç¼ºå¤±å¤„ç†
**è´¡çŒ®è€…**ï¼šAI Assistant + Userå®æˆ˜ç»éªŒæ€»ç»“
