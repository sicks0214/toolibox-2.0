# TooliBox å¯¼èˆªé¡µæŠ€æœ¯æ–‡æ¡£

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

TooliBox æ˜¯ä¸€ä¸ªå…è´¹åœ¨çº¿å·¥å…·èšåˆå¹³å°ï¼Œé‡‡ç”¨æ’ä»¶åŒ–æ¶æ„ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½å·¥å…·ã€‚

### æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|-----|------|
| å‰ç«¯ | Next.js 14 + TypeScript + Tailwind CSS |
| åç«¯ | Express.js + TypeScript |
| æ•°æ®åº“ | PostgreSQL + Prisma ORM |
| å›½é™…åŒ– | next-intl (æ”¯æŒ en/zh/es) |

### é¡¹ç›®ç»“æ„

```
toolibox-2.0/
â”œâ”€â”€ frontend/main/          # Next.js å‰ç«¯ (ç«¯å£ 3000)
â”œâ”€â”€ backend/                # Express åç«¯ (ç«¯å£ 8000)
â”‚   â”œâ”€â”€ plugins/            # æ’ä»¶ç›®å½•
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ plugin-loader.ts  # æ’ä»¶åŠ è½½å™¨
â”‚       â””â”€â”€ routes/plugins.ts # æ’ä»¶ API
â”œâ”€â”€ nginx/                  # Nginx é…ç½®
â””â”€â”€ docker-compose.yml      # å®¹å™¨ç¼–æ’
```

---

## äºŒã€æ’ä»¶ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒåŸç†

1. åç«¯å¯åŠ¨æ—¶æ‰«æ `backend/plugins/` ç›®å½•
2. åŠ è½½æ¯ä¸ªæ’ä»¶çš„é…ç½®ã€UIã€Schema å’Œå¤„ç†å‡½æ•°
3. è‡ªåŠ¨æ³¨å†Œ API è·¯ç”±
4. å‰ç«¯é€šè¿‡ `/api/plugins` è·å–å·¥å…·åˆ—è¡¨ï¼ŒåŠ¨æ€æ¸²æŸ“

### æ’ä»¶ç›®å½•ç»“æ„

```
backend/plugins/
â””â”€â”€ {plugin-name}/
    â”œâ”€â”€ plugin.json      # æ’ä»¶é…ç½® (å¿…éœ€)
    â”œâ”€â”€ ui.json          # UI é…ç½® (å¿…éœ€)
    â”œâ”€â”€ schema.json      # è¡¨å•é…ç½® (å¿…éœ€)
    â””â”€â”€ handler/
        â””â”€â”€ index.ts     # å¤„ç†å‡½æ•° (å¿…éœ€)
```

---

## ä¸‰ã€åˆ›å»ºæ–°æ’ä»¶

### æ­¥éª¤ 1ï¼šåˆ›å»ºæ’ä»¶ç›®å½•

```bash
mkdir -p backend/plugins/pdf-compress
```

### æ­¥éª¤ 2ï¼šåˆ›å»º plugin.json

```json
{
  "slug": "compress",
  "category": "pdf",
  "apiPath": "/api/pdf/compress",
  "order": 3
}
```

| å­—æ®µ | è¯´æ˜ |
|-----|------|
| slug | å·¥å…·å”¯ä¸€æ ‡è¯†ï¼Œç”¨äº URL |
| category | åˆ†ç±»ï¼š`pdf` æˆ– `image` |
| apiPath | API è·¯ç”±è·¯å¾„ |
| order | åœ¨åˆ†ç±»ä¸­çš„æ’åº |

### æ­¥éª¤ 3ï¼šåˆ›å»º ui.json

```json
{
  "title": {
    "en": "Compress PDF",
    "zh": "å‹ç¼© PDF",
    "es": "Comprimir PDF"
  },
  "description": {
    "en": "Reduce PDF file size while maintaining quality",
    "zh": "åœ¨ä¿æŒè´¨é‡çš„åŒæ—¶å‡å° PDF æ–‡ä»¶å¤§å°",
    "es": "Reducir el tamaÃ±o del archivo PDF manteniendo la calidad"
  },
  "h1": {
    "en": "Compress PDF Online",
    "zh": "åœ¨çº¿å‹ç¼© PDF",
    "es": "Comprimir PDF en lÃ­nea"
  },
  "icon": "ğŸ—œï¸",
  "faq": {
    "en": [
      {
        "question": "How much can I compress?",
        "answer": "Typically 50-80% size reduction."
      }
    ],
    "zh": [
      {
        "question": "å¯ä»¥å‹ç¼©å¤šå°‘ï¼Ÿ",
        "answer": "é€šå¸¸å¯å‡å°‘ 50-80% çš„æ–‡ä»¶å¤§å°ã€‚"
      }
    ]
  }
}
```

### æ­¥éª¤ 4ï¼šåˆ›å»º schema.json

```json
{
  "upload": {
    "multiple": false,
    "maxFiles": 1,
    "types": ["application/pdf"],
    "maxSize": 104857600
  },
  "options": [
    {
      "name": "quality",
      "type": "select",
      "label": {
        "en": "Compression Level",
        "zh": "å‹ç¼©çº§åˆ«"
      },
      "choices": [
        { "value": "high", "label": { "en": "High Quality", "zh": "é«˜è´¨é‡" } },
        { "value": "medium", "label": { "en": "Medium", "zh": "ä¸­ç­‰" } },
        { "value": "low", "label": { "en": "Maximum Compression", "zh": "æœ€å¤§å‹ç¼©" } }
      ],
      "default": "medium"
    }
  ],
  "submitText": {
    "en": "Compress PDF",
    "zh": "å‹ç¼© PDF"
  },
  "outputType": "file"
}
```

#### Schema å­—æ®µè¯´æ˜

**upload é…ç½®ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| multiple | boolean | æ˜¯å¦å…è®¸å¤šæ–‡ä»¶ä¸Šä¼  |
| maxFiles | number | æœ€å¤§æ–‡ä»¶æ•°é‡ |
| types | string[] | å…è®¸çš„ MIME ç±»å‹ |
| maxSize | number | æœ€å¤§æ–‡ä»¶å¤§å° (å­—èŠ‚) |

**options é€‰é¡¹ç±»å‹ï¼š**

| type | è¯´æ˜ | é¢å¤–å­—æ®µ |
|------|------|---------|
| select | ä¸‹æ‹‰é€‰æ‹© | choices |
| number | æ•°å­—è¾“å…¥ | min, max, default |
| text | æ–‡æœ¬è¾“å…¥ | placeholder |
| checkbox | å¤é€‰æ¡† | default |

### æ­¥éª¤ 5ï¼šåˆ›å»º handler/index.ts

```typescript
import { Request, Response } from 'express';
import { PDFDocument } from 'pdf-lib';

export default async function handler(req: Request, res: Response) {
  try {
    const file = req.file;
    if (!file) {
      return res.status(400).json({ error: 'No file uploaded' });
    }

    const quality = req.body.quality || 'medium';

    // å¤„ç† PDF
    const pdfDoc = await PDFDocument.load(file.buffer);

    // æ ¹æ® quality å‚æ•°è¿›è¡Œå‹ç¼©å¤„ç†
    // ... å‹ç¼©é€»è¾‘ ...

    const pdfBytes = await pdfDoc.save();

    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', 'attachment; filename="compressed.pdf"');
    res.send(Buffer.from(pdfBytes));

  } catch (error) {
    console.error('Compress error:', error);
    res.status(500).json({ error: 'Failed to compress PDF' });
  }
}
```

### æ­¥éª¤ 6ï¼šé‡å¯åç«¯

```bash
# å¼€å‘ç¯å¢ƒä¼šè‡ªåŠ¨çƒ­é‡è½½
# ç”Ÿäº§ç¯å¢ƒéœ€è¦é‡å¯æœåŠ¡
```

---

## å››ã€API æ¥å£

### è·å–æ‰€æœ‰æ’ä»¶

```
GET /api/plugins?lang=zh
```

å“åº”ï¼š
```json
{
  "success": true,
  "data": {
    "plugins": [
      {
        "slug": "compress",
        "category": "pdf",
        "apiPath": "/api/pdf/compress",
        "order": 3,
        "title": "å‹ç¼© PDF",
        "description": "åœ¨ä¿æŒè´¨é‡çš„åŒæ—¶å‡å° PDF æ–‡ä»¶å¤§å°",
        "icon": "ğŸ—œï¸",
        "schema": { ... }
      }
    ],
    "categories": {
      "pdf": [ ... ],
      "image": [ ... ]
    }
  }
}
```

### è·å–å•ä¸ªæ’ä»¶

```
GET /api/plugins/:slug?lang=zh
```

### è°ƒç”¨å·¥å…· API

```
POST /api/{category}/{slug}
Content-Type: multipart/form-data

file: <binary>
quality: medium
```

---

## äº”ã€å‰ç«¯å·¥å…·é¡µæ¸²æŸ“

### è·¯ç”±ç»“æ„

```
/{locale}/{categoryId}/{slug}
ä¾‹å¦‚: /zh/pdf-tools/compress
```

### å·¥å…·é¡µç»„ä»¶ (SchemaRenderer)

ä½ç½®ï¼š`frontend/main/src/components/tool/SchemaRenderer.tsx`

è¯¥ç»„ä»¶æ ¹æ® `schema.json` è‡ªåŠ¨æ¸²æŸ“ï¼š
- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
- é€‰é¡¹è¡¨å•
- æäº¤æŒ‰é’®
- ç»“æœä¸‹è½½

### æ•°æ®æµ

```
1. ç”¨æˆ·è®¿é—® /zh/pdf-tools/compress
2. å‰ç«¯è°ƒç”¨ GET /api/plugins/compress?lang=zh
3. è·å–æ’ä»¶é…ç½®å’Œ schema
4. SchemaRenderer æ¸²æŸ“è¡¨å•
5. ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶å¹¶æäº¤
6. å‰ç«¯è°ƒç”¨ POST /api/pdf/compress
7. åç«¯å¤„ç†å¹¶è¿”å›ç»“æœ
8. å‰ç«¯æä¾›ä¸‹è½½
```

---

## å…­ã€åˆ†ç±»é…ç½®

### æ”¯æŒçš„åˆ†ç±»

| category | categoryId | è¯´æ˜ |
|----------|------------|------|
| pdf | pdf-tools | PDF å·¥å…· |
| image | image-tools | å›¾åƒå·¥å…· |

### æ·»åŠ æ–°åˆ†ç±»

1. ä¿®æ”¹ `frontend/main/src/app/[locale]/page.tsx` ä¸­çš„ `categoryMeta`
2. ä¿®æ”¹ `frontend/main/src/app/[locale]/[categoryId]/page.tsx` ä¸­çš„ `categoryMeta`
3. ä¿®æ”¹ `frontend/main/src/components/layout/Header.tsx` ä¸­çš„ `categoryMeta`

---

## ä¸ƒã€æœ¬åœ°å¼€å‘

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åç«¯ (ç«¯å£ 8000)
cd backend
npm run dev

# å¯åŠ¨å‰ç«¯ (ç«¯å£ 3000)
cd frontend/main
npm run dev
```

### ç¯å¢ƒå˜é‡

åç«¯ `.env`:
```env
DATABASE_URL=postgresql://user:password@localhost:5432/toolibox
JWT_SECRET=your_secret_key
```

å‰ç«¯ `.env.local`:
```env
NEXT_PUBLIC_API_URL=http://localhost:8000
```

---

## å…«ã€æ’ä»¶å¼€å‘è§„èŒƒ

### å‘½åè§„èŒƒ

- æ’ä»¶ç›®å½•ï¼š`{category}-{action}`ï¼Œå¦‚ `pdf-compress`
- slugï¼šåŠ¨ä½œåï¼Œå¦‚ `compress`
- API è·¯å¾„ï¼š`/api/{category}/{slug}`

### æ–‡ä»¶å¤„ç†

- ä½¿ç”¨ `multer` ä¸­é—´ä»¶å¤„ç†æ–‡ä»¶ä¸Šä¼ 
- å•æ–‡ä»¶ï¼š`req.file`
- å¤šæ–‡ä»¶ï¼š`req.files`
- è¡¨å•å­—æ®µï¼š`req.body`

### å“åº”æ ¼å¼

**æ–‡ä»¶ä¸‹è½½ï¼š**
```typescript
res.setHeader('Content-Type', 'application/pdf');
res.setHeader('Content-Disposition', 'attachment; filename="output.pdf"');
res.send(buffer);
```

**JSON å“åº”ï¼š**
```typescript
res.json({ success: true, data: { ... } });
```

**é”™è¯¯å“åº”ï¼š**
```typescript
res.status(400).json({ error: 'Error message' });
```

---

## ä¹ã€å¸¸ç”¨ä¾èµ–

### PDF å¤„ç†
- `pdf-lib` - PDF åˆ›å»ºå’Œä¿®æ”¹
- `pdf-parse` - PDF æ–‡æœ¬æå–

### å›¾åƒå¤„ç†
- `sharp` - å›¾åƒè½¬æ¢ã€å‹ç¼©ã€è°ƒæ•´å¤§å°

### æ–‡ä»¶å¤„ç†
- `multer` - æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶
- `archiver` - ZIP å‹ç¼©

---

## åã€æ’ä»¶ç¤ºä¾‹

### å®Œæ•´ç¤ºä¾‹ï¼šPDF åˆå¹¶

**plugin.json:**
```json
{
  "slug": "merge",
  "category": "pdf",
  "apiPath": "/api/pdf/merge",
  "order": 1
}
```

**ui.json:**
```json
{
  "title": { "en": "Merge PDF", "zh": "åˆå¹¶ PDF" },
  "description": { "en": "Combine multiple PDFs into one", "zh": "å°†å¤šä¸ª PDF åˆå¹¶ä¸ºä¸€ä¸ª" },
  "h1": { "en": "Merge PDF Files", "zh": "åˆå¹¶ PDF æ–‡ä»¶" },
  "icon": "ğŸ“„",
  "faq": {
    "en": [{ "question": "How many files?", "answer": "Up to 20 files." }],
    "zh": [{ "question": "å¯ä»¥åˆå¹¶å¤šå°‘æ–‡ä»¶ï¼Ÿ", "answer": "æœ€å¤š 20 ä¸ªæ–‡ä»¶ã€‚" }]
  }
}
```

**schema.json:**
```json
{
  "upload": {
    "multiple": true,
    "maxFiles": 20,
    "types": ["application/pdf"],
    "maxSize": 104857600
  },
  "options": [],
  "submitText": { "en": "Merge PDFs", "zh": "åˆå¹¶ PDF" },
  "outputType": "file"
}
```

**handler/index.ts:**
```typescript
import { Request, Response } from 'express';
import { PDFDocument } from 'pdf-lib';

export default async function handler(req: Request, res: Response) {
  try {
    const files = req.files as Express.Multer.File[];
    if (!files || files.length < 2) {
      return res.status(400).json({ error: 'At least 2 files required' });
    }

    const mergedPdf = await PDFDocument.create();

    for (const file of files) {
      const pdf = await PDFDocument.load(file.buffer);
      const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
      pages.forEach(page => mergedPdf.addPage(page));
    }

    const pdfBytes = await mergedPdf.save();

    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', 'attachment; filename="merged.pdf"');
    res.send(Buffer.from(pdfBytes));

  } catch (error) {
    console.error('Merge error:', error);
    res.status(500).json({ error: 'Failed to merge PDFs' });
  }
}
```

---

## åä¸€ã€æ³¨æ„äº‹é¡¹

1. **æ’ä»¶çƒ­åŠ è½½**ï¼šå¼€å‘ç¯å¢ƒä¸‹ä¿®æ”¹æ’ä»¶é…ç½®åéœ€é‡å¯åç«¯
2. **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šé»˜è®¤ 100MBï¼Œå¯åœ¨ schema.json ä¸­é…ç½®
3. **CORS**ï¼šåç«¯å·²é…ç½®å…è®¸ localhost:3000 è®¿é—®
4. **é”™è¯¯å¤„ç†**ï¼šhandler ä¸­åŠ¡å¿… try-catch å¹¶è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯
5. **å›½é™…åŒ–**ï¼šæ‰€æœ‰ç”¨æˆ·å¯è§æ–‡æœ¬éƒ½éœ€è¦æä¾›å¤šè¯­è¨€ç‰ˆæœ¬
