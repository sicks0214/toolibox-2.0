# 登录系统部署指南

## 概述

已成功为 TooliBox 项目添加完整的用户认证登录系统。本文档详细说明如何在 VPS 上部署和测试该系统。

## 系统架构

### 技术栈
- **认证方式**: JWT (JSON Web Token)
- **密码加密**: bcryptjs (10 rounds)
- **会话管理**: 无状态认证 (Token 存储在 localStorage)
- **数据存储**: PostgreSQL

### 新增功能
1. ✅ 用户注册
2. ✅ 用户登录
3. ✅ 用户登出
4. ✅ 个人资料管理
5. ✅ 修改密码
6. ✅ JWT Token 认证
7. ✅ Header 用户菜单

---

## 1. 后端部署步骤

### 1.1 安装依赖包

```bash
cd backend
npm install
```

新增的包：
- `bcryptjs`: 密码哈希加密
- `jsonwebtoken`: JWT token 生成和验证
- `@types/bcryptjs`: TypeScript 类型定义
- `@types/jsonwebtoken`: TypeScript 类型定义

### 1.2 配置环境变量

编辑 `backend/.env` 文件，添加 JWT 配置：

```bash
# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=7d
```

**重要**: 在生产环境中，必须使用强随机密钥！可以使用以下命令生成：

```bash
# 生成随机密钥
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

### 1.3 运行数据库迁移

```bash
cd backend

# 生成 Prisma Client
npx prisma generate

# 创建迁移
npx prisma migrate dev --name add_user_table

# 或直接部署迁移（生产环境）
npx prisma migrate deploy
```

这将创建 `users` 表：
- id (自增主键)
- email (唯一)
- username (唯一)
- password (加密存储)
- firstName, lastName (可选)
- isActive, isEmailVerified (布尔标志)
- lastLoginAt (最后登录时间)
- createdAt, updatedAt (时间戳)

### 1.4 启动后端服务

```bash
# 开发环境
npm run dev

# 生产环境
npm run build
npm start

# 或使用 PM2
pm2 start dist/app.js --name toolibox-api
pm2 save
```

后端服务将在 `http://localhost:8000` 运行。

---

## 2. 前端部署步骤

### 2.1 安装依赖

前端无需安装额外依赖（使用现有的 axios）。

### 2.2 配置环境变量

编辑 `frontend/.env` 文件：

```bash
NEXT_PUBLIC_API_URL=http://localhost:8000
```

生产环境：
```bash
NEXT_PUBLIC_API_URL=https://api.toolibox.com
```

### 2.3 构建和启动前端

```bash
cd frontend

# 开发环境
npm run dev

# 生产环境
npm run build
npm start

# 或使用 PM2
pm2 start npm --name toolibox-frontend -- start
pm2 save
```

前端将在 `http://localhost:3000` 运行。

---

## 3. API 端点说明

### 认证相关 API

#### 1. 注册用户
```http
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "username": "john_doe",
  "password": "securePassword123",
  "firstName": "John",
  "lastName": "Doe"
}

Response:
{
  "success": true,
  "message": "User registered successfully",
  "data": {
    "user": { ... },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 2. 登录
```http
POST /api/auth/login
Content-Type: application/json

{
  "emailOrUsername": "john_doe",
  "password": "securePassword123"
}

Response:
{
  "success": true,
  "message": "Login successful",
  "data": {
    "user": { ... },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 3. 获取用户资料 (需要认证)
```http
GET /api/auth/profile
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "username": "john_doe",
      "firstName": "John",
      "lastName": "Doe",
      ...
    }
  }
}
```

#### 4. 更新用户资料 (需要认证)
```http
PUT /api/auth/profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "firstName": "John",
  "lastName": "Smith"
}
```

#### 5. 修改密码 (需要认证)
```http
POST /api/auth/change-password
Authorization: Bearer <token>
Content-Type: application/json

{
  "currentPassword": "oldPassword123",
  "newPassword": "newPassword456"
}
```

---

## 4. 前端路由

### 新增页面

1. **登录页面**: `/login` 或 `/zh/login`
2. **注册页面**: `/register` 或 `/zh/register`

### Header 变化

- **未登录状态**: 显示 "Login" 和 "Register" 按钮
- **已登录状态**: 显示用户名和下拉菜单
  - Profile (个人资料)
  - Logout (登出)

---

## 5. VPS 生产环境部署

### 5.1 更新 Nginx 配置

编辑 `/etc/nginx/sites-available/toolibox`:

```nginx
server {
    listen 80;
    server_name toolibox.com www.toolibox.com;

    # 前端
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

重新加载 Nginx：
```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 5.2 配置 SSL

```bash
sudo certbot --nginx -d toolibox.com -d www.toolibox.com
```

### 5.3 环境变量配置

**后端 `.env`**:
```bash
DATABASE_URL="postgresql://toolibox_user:STRONG_PASSWORD@localhost:5432/toolibox"
JWT_SECRET=生成的64字符随机密钥
JWT_EXPIRES_IN=7d
PORT=8000
NODE_ENV=production
FRONTEND_URL=https://toolibox.com
```

**前端 `.env`**:
```bash
NEXT_PUBLIC_API_URL=https://toolibox.com
```

### 5.4 启动服务

```bash
# 后端
cd /var/www/toolibox/backend
npm run build
pm2 start dist/app.js --name toolibox-api
pm2 startup
pm2 save

# 前端
cd /var/www/toolibox/frontend
npm run build
pm2 start npm --name toolibox-frontend -- start
pm2 save
```

---

## 6. 测试步骤

### 6.1 测试注册

```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "testuser",
    "password": "Test123456",
    "firstName": "Test",
    "lastName": "User"
  }'
```

### 6.2 测试登录

```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "emailOrUsername": "testuser",
    "password": "Test123456"
  }'
```

保存返回的 token。

### 6.3 测试获取资料

```bash
curl -X GET http://localhost:8000/api/auth/profile \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### 6.4 前端测试

1. 访问 `http://localhost:3000`
2. 点击 Header 的 "Register" 按钮
3. 填写注册表单并提交
4. 注册成功后自动登录，Header 显示用户名
5. 点击用户名下拉菜单，测试登出功能

---

## 7. 安全注意事项

### 7.1 生产环境必做

1. **更改 JWT_SECRET**: 使用强随机密钥
2. **使用 HTTPS**: 所有 API 请求必须通过 HTTPS
3. **密码策略**:
   - 最小长度: 6 字符（建议增加到 8+）
   - 考虑添加复杂度要求（大小写、数字、特殊字符）
4. **限流**: 添加登录失败限制（防止暴力破解）
5. **CORS 配置**: 限制允许的域名

### 7.2 可选增强

1. **邮箱验证**: 注册后发送验证邮件
2. **忘记密码**: 通过邮件重置密码
3. **双因素认证 (2FA)**
4. **会话管理**: Token 刷新机制
5. **审计日志**: 记录登录/登出活动

---

## 8. 数据库表结构

### Users 表

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    is_active BOOLEAN DEFAULT TRUE,
    is_email_verified BOOLEAN DEFAULT FALSE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
```

---

## 9. 故障排除

### 问题 1: Token 无效

**错误**: "Invalid token" 或 "Token expired"

**解决**:
- 检查 JWT_SECRET 是否一致
- Token 可能已过期（默认 7 天）
- 清除 localStorage 并重新登录

### 问题 2: 无法连接后端

**错误**: Network error

**解决**:
- 检查 NEXT_PUBLIC_API_URL 配置
- 检查后端服务是否运行: `pm2 list`
- 检查 CORS 配置

### 问题 3: 数据库连接失败

**错误**: Prisma connection error

**解决**:
- 检查 DATABASE_URL 配置
- 确认 PostgreSQL 服务运行: `sudo systemctl status postgresql`
- 运行迁移: `npx prisma migrate deploy`

### 问题 4: 密码哈希错误

**错误**: bcrypt error

**解决**:
- 重新安装 bcryptjs: `npm install bcryptjs`
- 检查 Node.js 版本（需要 18+）

---

## 10. 监控和维护

### 10.1 查看日志

```bash
# 查看 PM2 日志
pm2 logs toolibox-api
pm2 logs toolibox-frontend

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

### 10.2 数据库备份

```bash
# 备份用户数据
pg_dump -U toolibox_user toolibox -t users > users_backup.sql

# 恢复
psql -U toolibox_user toolibox < users_backup.sql
```

### 10.3 监控用户注册

```sql
-- 查看用户数量
SELECT COUNT(*) FROM users;

-- 查看最近注册的用户
SELECT id, email, username, created_at
FROM users
ORDER BY created_at DESC
LIMIT 10;

-- 查看活跃用户
SELECT COUNT(*) FROM users WHERE is_active = TRUE;
```

---

## 11. 下一步开发建议

1. **邮箱验证**: 集成邮件服务（SendGrid, AWS SES）
2. **社交登录**: Google, GitHub OAuth
3. **用户角色**: 添加 admin, user 角色系统
4. **账户设置**: 个人资料页面
5. **头像上传**: 整合 Cloudflare R2
6. **活动日志**: 记录用户操作历史

---

## 12. 文件清单

### 后端新增/修改文件
```
backend/
├── prisma/schema.prisma                    (修改)
├── src/
│   ├── app.ts                              (修改)
│   ├── controllers/authController.ts       (新增)
│   ├── middleware/auth.ts                  (新增)
│   └── routes/auth.ts                      (新增)
├── package.json                            (修改)
└── .env.example                            (修改)
```

### 前端新增/修改文件
```
frontend/
├── src/
│   ├── app/[locale]/
│   │   ├── login/page.tsx                  (新增)
│   │   ├── register/page.tsx               (新增)
│   │   └── layout.tsx                      (修改)
│   ├── components/layout/Header.tsx        (修改)
│   ├── contexts/AuthContext.tsx            (新增)
│   └── lib/auth.ts                         (新增)
```

---

## 联系与支持

如有问题，请查看：
- 项目文档: `/docs`
- GitHub Issues
- 邮箱: feedback@toolibox.com

---

**部署完成检查清单**:
- [ ] 后端依赖已安装
- [ ] 数据库迁移已完成
- [ ] JWT_SECRET 已配置（强随机密钥）
- [ ] 前端 API URL 已配置
- [ ] Nginx 配置已更新
- [ ] SSL 证书已配置
- [ ] PM2 服务已启动
- [ ] 注册功能测试通过
- [ ] 登录功能测试通过
- [ ] Token 认证测试通过
- [ ] Header 用户菜单正常显示

---

**版本**: v1.0
**最后更新**: 2025-12-08
