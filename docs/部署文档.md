# TooliBox 部署文档

## 一、部署架构

```
                    ┌─────────────────┐
                    │     Nginx       │
                    │   (反向代理)     │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  Frontend       │ │  Backend        │ │  PostgreSQL     │
│  (Next.js)      │ │  (Express)      │ │  (数据库)        │
│  Port: 3000     │ │  Port: 8000     │ │  Port: 5432     │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 二、前置要求

- VPS (推荐 2GB+ 内存)
- Docker & Docker Compose
- Nginx
- 域名 (可选，用于 HTTPS)

## 三、部署步骤

### 步骤 1：上传代码到 VPS

```bash
# 方式一：Git 克隆
git clone <your-repo-url> /opt/toolibox
cd /opt/toolibox

# 方式二：SCP 上传
scp -r ./toolibox-2.0 user@your-vps:/opt/toolibox
```

### 步骤 2：配置环境变量

```bash
# 创建 .env 文件
cat > /opt/toolibox/.env << 'EOF'
DATABASE_URL=postgresql://user:password@host.docker.internal:5432/toolibox
JWT_SECRET=your_jwt_secret_key
R2_ACCOUNT_ID=your_r2_account_id
R2_ACCESS_KEY_ID=your_r2_access_key
R2_SECRET_ACCESS_KEY=your_r2_secret_key
R2_BUCKET_NAME=your_bucket_name
EOF
```

### 步骤 3：构建并启动 Docker 容器

```bash
cd /opt/toolibox

# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f
```

### 步骤 4：配置 Nginx

```bash
# 复制 Nginx 配置
sudo cp nginx/toolibox.conf /etc/nginx/sites-available/toolibox
sudo ln -s /etc/nginx/sites-available/toolibox /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载 Nginx
sudo systemctl reload nginx
```

### 步骤 5：配置 HTTPS (可选)

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d toolibox.com -d www.toolibox.com

# 自动续期
sudo certbot renew --dry-run
```

## 四、Nginx 配置说明

```nginx
# HTTP 配置
server {
    listen 80;
    server_name toolibox.com;

    # 前端 (Next.js)
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}
```

## 五、常用运维命令

```bash
# 查看容器状态
docker-compose ps

# 重启服务
docker-compose restart

# 查看日志
docker-compose logs -f backend-main
docker-compose logs -f frontend-main

# 更新部署
git pull
docker-compose build
docker-compose up -d

# 进入容器调试
docker exec -it toolibox-backend-main sh
```

---

## 六、接入导航页指南

### 6.1 接入原理

工具页通过插件系统自动接入导航页：

```
1. 在 backend/plugins/ 创建插件目录
         ↓
2. 后端启动时自动扫描并加载插件
         ↓
3. 前端调用 GET /api/plugins 获取工具列表
         ↓
4. 导航页和分类页自动显示新工具
         ↓
5. 用户点击工具卡片进入工具页
```

### 6.2 创建新插件

#### 步骤 1：创建插件目录

```bash
mkdir -p backend/plugins/pdf-compress
```

#### 步骤 2：创建配置文件

**plugin.json** - 插件基础配置：
```json
{
  "slug": "compress",
  "category": "pdf",
  "apiPath": "/api/pdf/compress",
  "order": 1
}
```

**ui.json** - UI 显示配置：
```json
{
  "title": {
    "en": "Compress PDF",
    "zh": "压缩 PDF",
    "es": "Comprimir PDF"
  },
  "description": {
    "en": "Reduce PDF file size",
    "zh": "减小 PDF 文件大小",
    "es": "Reducir tamaño de PDF"
  },
  "h1": {
    "en": "Compress PDF Online",
    "zh": "在线压缩 PDF",
    "es": "Comprimir PDF en línea"
  },
  "icon": "🗜️",
  "faq": {
    "en": [{ "question": "...", "answer": "..." }],
    "zh": [{ "question": "...", "answer": "..." }]
  }
}
```

**schema.json** - 表单配置：
```json
{
  "upload": {
    "multiple": false,
    "maxFiles": 1,
    "types": ["application/pdf"],
    "maxSize": 104857600
  },
  "options": [],
  "submitText": {
    "en": "Compress PDF",
    "zh": "压缩 PDF"
  },
  "outputType": "file"
}
```

#### 步骤 3：创建处理函数

**handler/index.ts**：
```typescript
import { Request, Response } from 'express';
import { PDFDocument } from 'pdf-lib';

export default async function handler(req: Request, res: Response) {
  try {
    const file = req.file;
    if (!file) {
      return res.status(400).json({ error: 'No file uploaded' });
    }

    // 处理逻辑
    const pdfDoc = await PDFDocument.load(file.buffer);
    const pdfBytes = await pdfDoc.save();

    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', 'attachment; filename="compressed.pdf"');
    res.send(Buffer.from(pdfBytes));
  } catch (error) {
    res.status(500).json({ error: 'Processing failed' });
  }
}
```

#### 步骤 4：重启后端

```bash
# 开发环境 (自动热重载)
cd backend && npm run dev

# 生产环境
docker-compose restart backend-main
```

### 6.3 验证接入

1. 访问 API 确认插件已加载：
```bash
curl http://localhost:8000/api/plugins?lang=zh
```

2. 检查导航页是否显示新工具

3. 访问工具页测试功能：
```
http://localhost:3000/zh/pdf-tools/compress
```

### 6.4 导航页显示位置

新插件会自动出现在以下位置：

| 位置 | 说明 |
|-----|------|
| 首页分类区 | 显示在对应分类下的工具列表 |
| 导航栏下拉菜单 | Header 中的分类下拉菜单 |
| 分类页 | `/zh/pdf-tools` 页面的工具网格 |

### 6.5 分类配置

如需添加新分类，需修改以下文件：

1. **首页** `frontend/main/src/app/[locale]/page.tsx`：
   - `categoryMeta` - 分类元数据
   - `categoryPages` - 首页分类入口卡片

2. **分类页** `frontend/main/src/app/[locale]/[categoryId]/page.tsx`：
   - `categoryMeta` - 分类元数据

3. **导航栏** `frontend/main/src/components/layout/Header.tsx`：
   - `categoryMeta` - 分类元数据
   - 下拉菜单配置

### 6.6 插件目录结构

```
backend/plugins/
├── pdf-compress/
│   ├── plugin.json      # 必需：插件配置
│   ├── ui.json          # 必需：UI 配置
│   ├── schema.json      # 必需：表单配置
│   └── handler/
│       └── index.ts     # 必需：处理函数
├── pdf-merge/
│   └── ...
└── image-resize/
    └── ...
```

### 6.7 常见问题

**Q: 插件不显示在导航页？**
- 检查 plugin.json 的 category 是否正确 (pdf/image)
- 确认后端已重启
- 查看后端日志确认插件已加载

**Q: 工具页 404？**
- 确认 URL 格式：`/{locale}/{categoryId}/{slug}`
- categoryId 应为 `pdf-tools` 或 `image-tools`
- slug 应与 plugin.json 中的 slug 一致

**Q: API 调用失败？**
- 检查 apiPath 配置是否正确
- 确认 handler 函数已正确导出
- 查看后端日志排查错误
